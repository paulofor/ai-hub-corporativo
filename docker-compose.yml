services:
  backend:
    image: ${BACKEND_IMAGE:-ghcr.io/paulofor/ai-hub-corporativo-backend:latest}
    pull_policy: missing
    restart: unless-stopped
    command: >
      /bin/sh -c "if [ -f /run/secrets/openai-token/openai_api_key ]; then
        export OPENAI_API_KEY=$(cat /run/secrets/openai-token/openai_api_key);
      elif [ -f /run/secrets/openai-token/open_api_key ]; then
        export OPENAI_API_KEY=$(cat /run/secrets/openai-token/open_api_key);
      fi;
      exec java -jar /app/app.jar"
    env_file:
      - apps/backend/.env.example
      - .env
    depends_on:
      - sandbox-orchestrator
    volumes:
      - ./infra:/infra
      - ${OPENAI_TOKEN_HOST_DIR:-/root/infra/openai-token}:/run/secrets/openai-token:ro
    ports:
      - "${BACKEND_HTTP_PORT:-8081}:8081"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8081/actuator/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 120s
    networks:
      default:
        aliases:
          - backend

  frontend:
    image: ${FRONTEND_IMAGE:-ghcr.io/paulofor/ai-hub-corporativo-frontend:latest}
    pull_policy: missing
    env_file:
      - apps/frontend/.env.example
      - .env
    depends_on:
      - backend
    ports:
      - "${FRONTEND_HTTP_PORT:-8082}:80"
    networks:
      default:
      public-net:
        aliases:
          - aihub-frontend

  reverse-proxy-cert-init:
    image: alpine:3.19
    restart: "no"
    command:
      - /bin/sh
      - -c
      - |
          set -euo pipefail
          apk add --no-cache openssl >/dev/null
          live_dir=/etc/letsencrypt/live/iahubcorp.online
          fullchain="$$live_dir/fullchain.pem"
          privkey="$$live_dir/privkey.pem"
          if [ -s "$$fullchain" ] && [ -s "$$privkey" ]; then
            echo "Existing certificate detected."
            exit 0
          fi
          mkdir -p "$$live_dir"
          openssl req -x509 -nodes -newkey rsa:2048 -days 365 \
            -keyout "$$privkey" \
            -out "$$fullchain" \
            -subj "/CN=iahubcorp.online"
          chmod 600 "$$privkey"
          chmod 644 "$$fullchain"
          echo "Self-signed certificate generated for iahubcorp.online."
    volumes:
      - ./infra/nginx/letsencrypt:/etc/letsencrypt

  reverse-proxy:
    image: nginx:1.25-alpine
    restart: unless-stopped
    environment:
      NGINX_RELOAD_INTERVAL: 6h
    command:
      - /bin/sh
      - -c
      - |
          set -e
          nginx -g "daemon off;" &
          nginx_pid=$$!
          while :; do
            sleep "$${NGINX_RELOAD_INTERVAL}"
            nginx -s reload || true
          done &
          wait "$$nginx_pid"
    depends_on:
      reverse-proxy-cert-init:
        condition: service_completed_successfully
      frontend:
        condition: service_started
      backend:
        condition: service_healthy
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./infra/nginx/frontend.conf:/etc/nginx/conf.d/default.conf:ro
      - ./infra/nginx/letsencrypt:/etc/letsencrypt:ro
      - ./infra/nginx/certbot-www:/var/www/certbot:ro
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://backend:8081/actuator/health >/dev/null || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
    networks:
      default:
      public-net:
        aliases:
          - iahubcorp.online

  certbot:
    image: certbot/certbot:v2.10.0
    profiles:
      - certbot
    command: ["--version"]
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./infra/nginx/letsencrypt:/etc/letsencrypt
      - ./infra/nginx/certbot-www:/var/www/certbot

  sandbox-orchestrator:
    image: ${SANDBOX_ORCHESTRATOR_IMAGE:-ghcr.io/paulofor/ai-hub-corporativo-sandbox:latest}
    pull_policy: missing
    env_file:
      - apps/sandbox-orchestrator/.env.example
      - .env
    volumes:
      - ${OPENAI_TOKEN_HOST_DIR:-/root/infra/openai-token}:/run/secrets/openai-token:ro
      - ${SANDBOX_WORKDIR:-/root/ai-hub-corporativo/src}:${SANDBOX_WORKDIR:-/root/ai-hub-corporativo/src}
    ports:
      - "${SANDBOX_ORCHESTRATOR_HTTP_PORT:-8083}:8080"
    command: >
      /bin/sh -c "if [ -f /run/secrets/openai-token/openai_api_key ]; then
        export OPENAI_API_KEY=$(cat /run/secrets/openai-token/openai_api_key);
      elif [ -f /run/secrets/openai-token/open_api_key ]; then
        export OPENAI_API_KEY=$(cat /run/secrets/openai-token/open_api_key);
      fi;
      exec node dist/src/index.js"
    networks:
      default:
        aliases:
          - sandbox-orchestrator
      public-net:
        aliases:
          - sandbox-orchestrator

networks:
  default:
  public-net:
    external: true
