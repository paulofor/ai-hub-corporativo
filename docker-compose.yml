services:
  backend:
    image: ${BACKEND_IMAGE:-ghcr.io/paulodb/ai-hub-corporativo-backend:latest}
    build:
      context: ./apps/backend
    pull_policy: never
    command: >
      /bin/sh -c "if [ -f /run/secrets/openai-token/openai_api_key ]; then
        export OPENAI_API_KEY=$(cat /run/secrets/openai-token/openai_api_key);
      fi;
      exec java -jar /app/app.jar"
    env_file:
      - apps/backend/.env.example
      - .env
    depends_on:
      - sandbox-orchestrator
    volumes:
      - ./infra:/infra
      - ${OPENAI_TOKEN_HOST_DIR:-/root/infra/openai-token}:/run/secrets/openai-token:ro
    ports:
      - "${BACKEND_HTTP_PORT:-8081}:8081"
    networks:
      default:
        aliases:
          - backend

  frontend:
    image: ${FRONTEND_IMAGE:-ghcr.io/paulodb/ai-hub-corporativo-frontend:latest}
    build:
      context: ./apps/frontend
    pull_policy: never
    env_file:
      - apps/frontend/.env.example
      - .env
    depends_on:
      - backend
    ports:
      - "${FRONTEND_HTTP_PORT:-8082}:80"
    networks:
      default:
      public-net:
        aliases:
          - aihub-frontend

  reverse-proxy:
    image: nginx:1.25-alpine
    depends_on:
      - frontend
      - backend
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./infra/nginx/frontend.conf:/etc/nginx/conf.d/default.conf:ro
      - ./infra/nginx/letsencrypt:/etc/letsencrypt:ro
      - ./infra/nginx/certbot-www:/var/www/certbot:ro
    networks:
      default:
      public-net:
        aliases:
          - iahubcorp.online

  certbot:
    image: certbot/certbot:v2.10.0
    profiles:
      - certbot
    command: ["--version"]
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./infra/nginx/letsencrypt:/etc/letsencrypt
      - ./infra/nginx/certbot-www:/var/www/certbot

  sandbox-orchestrator:
    image: ${SANDBOX_ORCHESTRATOR_IMAGE:-ghcr.io/paulodb/ai-hub-corporativo-sandbox:latest}
    build:
      context: ./apps/sandbox-orchestrator
    pull_policy: never
    env_file:
      - apps/sandbox-orchestrator/.env.example
      - .env
    volumes:
      - ${OPENAI_TOKEN_HOST_DIR:-/root/infra/openai-token}:/run/secrets/openai-token:ro
      - ${SANDBOX_WORKDIR:-/root/ai-hub-corporativo/src}:${SANDBOX_WORKDIR:-/root/ai-hub-corporativo/src}
    ports:
      - "${SANDBOX_ORCHESTRATOR_HTTP_PORT:-8083}:8080"
    command: >
      /bin/sh -c "if [ -f /run/secrets/openai-token/openai_api_key ]; then
        export OPENAI_API_KEY=$(cat /run/secrets/openai-token/openai_api_key);
      fi;
      exec node dist/src/index.js"
    networks:
      default:
        aliases:
          - sandbox-orchestrator
      public-net:
        aliases:
          - sandbox-orchestrator

networks:
  default:
  public-net:
    external: true
